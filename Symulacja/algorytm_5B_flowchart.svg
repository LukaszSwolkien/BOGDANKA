<?xml version="1.0" encoding="UTF-8"?>
<svg width="1400" height="3220" xmlns="http://www.w3.org/2000/svg">

<!-- White background -->
<rect width="1400" height="3220" fill="#ffffff"/>

<style>
  .title { font-family: Arial, sans-serif; font-size: 28px; font-weight: bold; fill: #1a1a1a; }
  .subtitle { font-family: Arial, sans-serif; font-size: 18px; fill: #555; }
  .box-text { font-family: Arial, sans-serif; font-size: 15px; fill: #1a1a1a; text-anchor: middle; }
  .box-text-small { font-family: Arial, sans-serif; font-size: 13px; fill: #1a1a1a; text-anchor: middle; }
  .box-label { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #1a1a1a; }
  .decision { fill: #fff3cd; stroke: #ffc107; stroke-width: 2; }
  .process { fill: #d4edda; stroke: #28a745; stroke-width: 2; }
  .start-end { fill: #cce5ff; stroke: #0066cc; stroke-width: 3; rx: 25; }
  .action { fill: #f8d7da; stroke: #dc3545; stroke-width: 2; }
  .data { fill: #e7f3ff; stroke: #007bff; stroke-width: 2; }
  .warning { fill: #fff3cd; stroke: #ff8800; stroke-width: 2; }
  .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
  .arrow-yes { stroke: #28a745; stroke-width: 2.5; fill: none; marker-end: url(#arrowhead-yes); }
  .arrow-no { stroke: #dc3545; stroke-width: 2.5; fill: none; marker-end: url(#arrowhead-no); }
  .label { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #28a745; }
  .label-no { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #dc3545; }
  .note { font-family: Arial, sans-serif; font-size: 12px; fill: #666; font-style: italic; }
  .loop { font-family: Arial, sans-serif; font-size: 13px; fill: #0066cc; font-style: italic; }
</style>

<defs>
  <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
    <polygon points="0 0, 10 3, 0 6" fill="#333" />
  </marker>
  <marker id="arrowhead-yes" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
    <polygon points="0 0, 10 3, 0 6" fill="#28a745" />
  </marker>
  <marker id="arrowhead-no" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
    <polygon points="0 0, 10 3, 0 6" fill="#dc3545" />
  </marker>
</defs>

<!-- Title -->
<text class="title" x="700" y="40" text-anchor="middle">Algorytm 5B: Rotacja Nagrzewnic w ObrÄ™bie CiÄ…gu</text>
<text class="subtitle" x="700" y="65" text-anchor="middle">WyrÃ³wnanie Czasu Pracy N1-N8 (z koordynacjÄ… 5A)</text>

<!-- START -->
<rect class="start-end" x="550" y="90" width="300" height="60"/>
<text class="box-text" x="700" y="125">START - GÅ‚Ã³wna pÄ™tla</text>
<text class="box-text-small" x="700" y="142">(co CYKL_PÄ˜TLI, domyÅ›lnie 60s)</text>
<line class="arrow" x1="700" y1="150" x2="700" y2="180"/>

<!-- Zmienne globalne -->
<rect class="warning" x="450" y="190" width="500" height="90"/>
<text class="box-text-small" x="700" y="210">âš™ï¸ Zmienne globalne (koordynacja z 5A):</text>
<text class="box-text-small" x="700" y="227">aktualny_ukÅ‚ad, zmiana_ukÅ‚adu_w_toku,</text>
<text class="box-text-small" x="700" y="244">czas_ostatniej_zmiany_ukÅ‚adu,</text>
<text class="box-text-small" x="700" y="261">rotacja_nagrzewnic_w_toku,</text>
<text class="box-text-small" x="700" y="278">czas_ostatniej_rotacji_globalny</text>
<line class="arrow" x1="700" y1="280" x2="700" y2="310"/>

<!-- PÄ™tla DLA KAÅ»DEGO CIÄ„GU -->
<rect class="process" x="550" y="320" width="300" height="50"/>
<text class="box-text" x="700" y="345">DLA KAÅ»DEGO ciÄ…gu</text>
<text class="box-text-small" x="700" y="362">w [CIÄ„G1, CIÄ„G2]</text>
<line class="arrow" x1="700" y1="370" x2="700" y2="410"/>

<!-- KROK 0: SprawdÅº aktywnoÅ›Ä‡ ciÄ…gu (NOWY - KRYTYCZNY!) -->
<text class="box-label" x="50" y="460">KROK 0</text>
<polygon class="decision" points="700,420 1050,520 700,620 350,520"/>
<text class="box-text" x="700" y="500">CiÄ…g aktywny w aktualnym</text>
<text class="box-text" x="700" y="520">ukÅ‚adzie/scenariuszu?</text>
<text class="box-text-small" x="700" y="540">S1-S4: C1(Podst) lub C2(Ogr)</text>
<text class="box-text-small" x="700" y="557">S5-S8: tylko C2 (C1 niemoÅ¼liwa)</text>

<!-- NIE - pomiÅ„ ciÄ…g -->
<line class="arrow-no" x1="350" y1="520" x2="200" y2="520"/>
<text class="label-no" x="250" y="510">NIE</text>
<rect class="action" x="50" y="490" width="150" height="60"/>
<text class="box-text-small" x="125" y="515">POMIÅƒ ciÄ…g</text>
<text class="box-text-small" x="125" y="532">(ciÄ…g wyÅ‚Ä…czony)</text>
<line class="arrow-no" x1="125" y1="550" x2="125" y2="2980"/>
<line class="arrow-no" x1="125" y1="2980" x2="600" y2="2980"/>

<!-- TAK - kontynuuj do KROK 1 -->
<line class="arrow-yes" x1="700" y1="620" x2="700" y2="670"/>
<text class="label" x="720" y="650">TAK</text>

<!-- KROK 1: Aktualizuj liczniki -->
<text class="box-label" x="50" y="705">KROK 1</text>
<rect class="data" x="500" y="680" width="400" height="70"/>
<text class="box-text-small" x="700" y="705">Aktualizuj liczniki:</text>
<text class="box-text-small" x="700" y="722">DLA KAÅ»DEJ nagrzewnicy ciÄ…gu:</text>
<text class="box-text-small" x="700" y="739">czas_pracy[N] lub czas_postoju[N] += 1</text>
<line class="arrow" x1="700" y1="750" x2="700" y2="790"/>

<!-- KROK 2: SprawdÅº warunki rotacji (ROZSZERZONY) -->
<text class="box-label" x="50" y="865">KROK 2</text>
<polygon class="decision" points="700,800 1050,920 700,1040 350,920"/>
<text class="box-text" x="700" y="885">Warunki rotacji speÅ‚nione?</text>
<text class="box-text-small" x="700" y="905">1. Czy 5A nie zmienia ukÅ‚adu?</text>
<text class="box-text-small" x="700" y="922">2. UpÅ‚ynÄ™Å‚a 1h od zmiany ukÅ‚adu?</text>
<text class="box-text-small" x="700" y="939">3. UpÅ‚ynÄ™Å‚o 15min od rotacji?</text>
<text class="box-text-small" x="700" y="956">4. Sprawne, okres, stabilnoÅ›Ä‡ OK?</text>

<!-- NIE - pomiÅ„ ciÄ…g -->
<line class="arrow-no" x1="350" y1="920" x2="200" y2="920"/>
<text class="label-no" x="250" y="910">NIE</text>
<line class="arrow-no" x1="200" y1="920" x2="200" y2="3000"/>
<line class="arrow-no" x1="200" y1="3000" x2="650" y2="3000"/>

<!-- TAK - kontynuuj -->
<line class="arrow-yes" x1="700" y1="1040" x2="700" y2="1090"/>
<text class="label" x="720" y="1070">TAK</text>

<!-- KROK 3: Wybierz nagrzewnice -->
<text class="box-label" x="50" y="1145">KROK 3</text>
<rect class="process" x="500" y="1100" width="400" height="90"/>
<text class="box-text-small" x="700" y="1125">Wybierz nagrzewnicÄ™:</text>
<text class="box-text-small" x="700" y="1142">â€¢ do WYÅÄ„CZENIA: najdÅ‚uÅ¼ej pracujÄ…ca</text>
<text class="box-text-small" x="700" y="1159">  (przy rÃ³wnych czasach: wczeÅ›niejszy timestamp)</text>
<text class="box-text-small" x="700" y="1176">â€¢ do ZAÅÄ„CZENIA: najdÅ‚uÅ¼ej w postoju</text>
<line class="arrow" x1="700" y1="1190" x2="700" y2="1230"/>

<!-- SprawdÅº MIN_DELTA -->
<polygon class="decision" points="700,1240 950,1300 700,1360 450,1300"/>
<text class="box-text" x="700" y="1290">delta_czasu â‰¥</text>
<text class="box-text" x="700" y="1310">MIN_DELTA_CZASU?</text>

<!-- NIE - pomiÅ„ -->
<line class="arrow-no" x1="950" y1="1300" x2="1100" y2="1300"/>
<text class="label-no" x="1000" y="1290">NIE</text>
<line class="arrow-no" x1="1100" y1="1300" x2="1100" y2="3020"/>
<line class="arrow-no" x1="1100" y1="3020" x2="750" y2="3020"/>

<!-- TAK - kontynuuj do KROK 4 -->
<line class="arrow-yes" x1="700" y1="1360" x2="700" y2="1410"/>
<text class="label" x="720" y="1390">TAK</text>

<!-- KROK 4: Wykonaj rotacjÄ™ (z blokadami) -->
<text class="box-label" x="50" y="1445">KROK 4</text>
<rect class="warning" x="550" y="1420" width="300" height="50"/>
<text class="box-text-small" x="700" y="1440">ğŸ”’ Ustaw blokadÄ™:</text>
<text class="box-text-small" x="700" y="1457">rotacja_nagrzewnic_w_toku = PRAWDA</text>
<line class="arrow" x1="700" y1="1470" x2="700" y2="1510"/>

<!-- Rejestruj rozpoczÄ™cie -->
<rect class="data" x="550" y="1520" width="300" height="50"/>
<text class="box-text-small" x="700" y="1545">ğŸ“ Rejestruj zdarzenie:</text>
<text class="box-text-small" x="700" y="1562">"Rotacja N_stara â†’ N_nowa"</text>
<line class="arrow" x1="700" y1="1570" x2="700" y2="1610"/>

<!-- Wykonaj rotacjÄ™ -->
<rect class="action" x="500" y="1620" width="400" height="60"/>
<text class="box-text" x="700" y="1645">âš™ï¸ Wykonaj_RotacjÄ™_Nagrzewnicy()</text>
<text class="box-text-small" x="700" y="1665">(szczegÃ³Å‚y poniÅ¼ej)</text>
<line class="arrow" x1="700" y1="1680" x2="700" y2="1720"/>

<!-- Sekwencja rotacji -->
<rect class="process" x="520" y="1730" width="360" height="30"/>
<text class="box-text-small" x="700" y="1750">1. Ustaw zawÃ³r N_nowa na 20%</text>
<line class="arrow" x1="700" y1="1760" x2="700" y2="1780"/>

<rect class="process" x="520" y="1790" width="360" height="30"/>
<text class="box-text-small" x="700" y="1810">2. OtwÃ³rz przepustnicÄ™ N_nowa</text>
<line class="arrow" x1="700" y1="1820" x2="700" y2="1840"/>

<rect class="process" x="520" y="1850" width="360" height="30"/>
<text class="box-text-small" x="700" y="1870">3. Aktywuj N_nowa (zawÃ³r PID â†’ 100%)</text>
<line class="arrow" x1="700" y1="1880" x2="700" y2="1900"/>

<rect class="process" x="520" y="1910" width="360" height="30"/>
<text class="box-text-small" x="700" y="1930">4. Czekaj na stabilizacjÄ™ (30s)</text>
<line class="arrow" x1="700" y1="1940" x2="700" y2="1960"/>

<rect class="process" x="520" y="1970" width="360" height="30"/>
<text class="box-text-small" x="700" y="1990">5. Deaktywuj N_stara (zawÃ³r â†’ 20%)</text>
<line class="arrow" x1="700" y1="2000" x2="700" y2="2020"/>

<rect class="process" x="520" y="2030" width="360" height="30"/>
<text class="box-text-small" x="700" y="2050">6. Zamknij przepustnicÄ™ N_stara</text>
<line class="arrow" x1="700" y1="2060" x2="700" y2="2080"/>

<rect class="process" x="520" y="2090" width="360" height="30"/>
<text class="box-text-small" x="700" y="2110">7. Zamknij zawÃ³r N_stara (0%)</text>
<line class="arrow" x1="700" y1="2120" x2="700" y2="2160"/>

<!-- Aktualizacja stanu -->
<rect class="data" x="500" y="2170" width="400" height="90"/>
<text class="box-text-small" x="700" y="2195">Aktualizuj stan:</text>
<text class="box-text-small" x="700" y="2212">â€¢ nagrzewnice_aktywne[ciÄ…g]</text>
<text class="box-text-small" x="700" y="2229">â€¢ czas_ostatniej_rotacji[ciÄ…g]</text>
<text class="box-text-small" x="700" y="2246">â€¢ czas_ostatniej_rotacji_globalny (15min)</text>
<line class="arrow" x1="700" y1="2260" x2="700" y2="2300"/>

<!-- Rejestruj zakoÅ„czenie -->
<rect class="data" x="550" y="2310" width="300" height="50"/>
<text class="box-text-small" x="700" y="2335">ğŸ“ Rejestruj zdarzenie:</text>
<text class="box-text-small" x="700" y="2352">"Rotacja zakoÅ„czona pomyÅ›lnie"</text>
<line class="arrow" x1="700" y1="2360" x2="700" y2="2400"/>

<!-- Zwolnij blokadÄ™ -->
<rect class="warning" x="550" y="2410" width="300" height="50"/>
<text class="box-text-small" x="700" y="2430">ğŸ”“ Zwolnij blokadÄ™:</text>
<text class="box-text-small" x="700" y="2447">rotacja_nagrzewnic_w_toku = FAÅSZ</text>
<line class="arrow" x1="700" y1="2460" x2="700" y2="2500"/>

<!-- Monitorowanie -->
<rect class="data" x="550" y="2510" width="300" height="100"/>
<text class="box-text-small" x="700" y="2535">Monitoruj i aktualizuj:</text>
<text class="box-text-small" x="700" y="2552">â€¢ czas_pracy[N1..N8]</text>
<text class="box-text-small" x="700" y="2569">â€¢ czas_postoju[N1..N8]</text>
<text class="box-text-small" x="700" y="2586">â€¢ liczba_rotacji[CIÄ„G]</text>
<text class="box-text-small" x="700" y="2603">â€¢ stosunek_eksploatacji[N1..N8]</text>
<line class="arrow" x1="700" y1="2610" x2="700" y2="2670"/>

<!-- SprawdÅº czy wiÄ™cej ciÄ…gÃ³w -->
<polygon class="decision" points="700,2680 900,2740 700,2800 500,2740"/>
<text class="box-text" x="700" y="2730">WiÄ™cej ciÄ…gÃ³w</text>
<text class="box-text" x="700" y="2750">do sprawdzenia?</text>

<!-- TAK - nastÄ™pny ciÄ…g -->
<line class="arrow-yes" x1="500" y1="2740" x2="350" y2="2740"/>
<text class="label" x="400" y="2730">TAK</text>
<line class="arrow-yes" x1="350" y1="2740" x2="350" y2="345"/>
<line class="arrow-yes" x1="350" y1="345" x2="550" y2="345"/>

<!-- NIE - koniec pÄ™tli ciÄ…gÃ³w -->
<line class="arrow-no" x1="700" y1="2800" x2="700" y2="2860"/>
<text class="label-no" x="720" y="2835">NIE</text>

<!-- Punkt zbiorczy -->
<line class="arrow" x1="600" y1="2980" x2="675" y2="2980"/>
<line class="arrow" x1="650" y1="3000" x2="675" y2="3000"/>
<line class="arrow" x1="750" y1="3020" x2="725" y2="3020"/>
<line class="arrow" x1="700" y1="2860" x2="700" y2="2980"/>
<line class="arrow" x1="700" y1="2980" x2="700" y2="2940"/>

<!-- Czekaj -->
<rect class="process" x="550" y="2950" width="300" height="50"/>
<text class="box-text" x="700" y="2980">Czekaj CYKL_PÄ˜TLI</text>

<!-- PÄ™tla zwrotna -->
<line class="arrow" x1="550" y1="2975" x2="50" y2="2975"/>
<line class="arrow" x1="50" y1="2975" x2="50" y2="120"/>
<line class="arrow" x1="50" y1="120" x2="550" y2="120"/>

<!-- Legend -->
<rect x="50" y="3030" width="1300" height="150" fill="#f8f9fa" stroke="#dee2e6" stroke-width="1"/>
<text class="note" x="70" y="3050">Legenda:</text>
<rect class="decision" x="170" y="3035" width="60" height="30"/>
<text class="note" x="240" y="3053">Decyzja</text>
<rect class="process" x="320" y="3035" width="60" height="30"/>
<text class="note" x="390" y="3053">Proces</text>
<rect class="action" x="470" y="3035" width="60" height="30"/>
<text class="note" x="540" y="3053">Akcja rotacji</text>
<rect class="data" x="630" y="3035" width="60" height="30"/>
<text class="note" x="700" y="3053">Dane/Log</text>
<rect class="warning" x="780" y="3035" width="60" height="30"/>
<text class="note" x="850" y="3053">Blokada/Sync</text>

<text class="note" x="70" y="3085">âš™ï¸ Parametry technologa:</text>
<text class="note" x="90" y="3105">â€¢ OKRES_ROTACJI_NAGRZEWNIC = 168h-720h (typowo 168h = 7 dni)</text>
<text class="note" x="90" y="3125">â€¢ MIN_DELTA_CZASU = 1800-7200s (typowo 3600s = 1h)</text>
<text class="note" x="90" y="3145">â€¢ CYKL_PÄ˜TLI_ALGORYTMÃ“W = 10-600s (domyÅ›lnie 60s = 1 min, wspÃ³Å‚dzielony z 5A)</text>

<text class="note" x="70" y="3175">ğŸ”’ Koordynacja z Algorytmem 5A:</text>
<text class="note" x="90" y="3195">â€¢ KROK 0: Sprawdza czy ciÄ…g aktywny (S1-S4: C1 lub C2, S5-S8: tylko C2)</text>

</svg>
